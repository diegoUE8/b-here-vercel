{"version":3,"sources":["../../../src/js/prefetch/prefetch.service.worker.js"],"names":["f","define","amd","PrefetchServiceWorkerEvent","prefetched","controllers","sendMessage","type","assets","data","self","postMessage","addEventListener","event","id","controller","abort","length","Promise","fetch","options","mode","AbortController","signal","promises","onProgress","total","loaded","promise","then","all","PromiseAllProgress","map","url","resolve","reject","_","error","Prefetch","progress","catch","console","log"],"mappings":";;;;;CACA,SAAAA,GAAA,mBAAAC,QAAAA,OAAAC,IAAAD,OAAAD,GAAAA,IAAA,EAAA,WAAA,aAAA,MAAMG,EACK,WADLA,EAEK,WAGLC,EAAa,GACbC,EAAc,GAEpB,SAASC,EAAYC,EAAMC,EAAQC,GAClCC,KAAKC,YAAY,CAChBJ,KAAMA,EACNC,OAAQA,EACRC,KAAMA,IAiDRC,KAAKE,iBAAiB,WA7CtB,SAAmBC,GAClB,MAAMC,EAAKD,EAAMJ,KAAKK,GAChBN,EAASK,EAAMJ,KAAKD,OAEtB,IAACM,EACJ,OAED,GAAIA,IAAON,EAAQ,CAClB,MAAMO,EAAaV,EAAYS,GAK/B,YAJIC,GAEHA,EAAWC,SAIb,IAAKR,EAAOS,OACX,OAED,GAAuB,oBAAZC,QACV,OAED,GAAqB,mBAAVC,MACV,OAED,MAAMC,EAAU,CACfC,KAAM,QAEHX,GAAAA,KAAKY,gBAAiB,CACzB,MAAMP,EAAa,IAAIO,gBACvBF,EAAQG,OAASR,EAAWQ,OAC5BlB,EAAYS,GAAMC,EAGnB,OA+BD,SAA4BS,EAAUC,GACrC,MAAMC,EAAQF,EAASP,OACnBU,IAAAA,EAAS,EACa,mBAAfF,GACVA,EAAW,CAAEE,OAAAA,EAAQD,MAAAA,IAEtB,IAAK,MAAME,KAAWJ,EACrBI,EAAQC,MAAK,KACZF,IAC0B,mBAAfF,GACVA,EAAW,CAAEE,OAAAA,EAAQD,MAAAA,OAIxB,OAAOR,QAAQY,IAAIN,GA7CZO,CAAmBvB,EAAOwB,KAAIC,GActC,SAAkBA,EAAKb,GACtB,OAAO,IAAIF,SAAQ,CAACgB,EAASC,KACX/B,EAAW6B,GAE3BC,EAAQD,GAERd,MAAMc,EAAKb,GAASS,MAAK,SAASO,GACjChC,EAAW6B,IAAO,EAClBC,EAAQD,MACN,SAASI,GAEXF,EAAOE,SAzBkCC,CAASL,EAAKb,MAAW,SAASmB,GAE7EjC,EAAYH,EAAqCK,EAAQ+B,MACvDV,MAAK,SAASO,UACT/B,EAAYS,GAEnBR,EAAYH,EAAqCK,MAC/CgC,OAAM,SAASH,GACjBI,QAAQC,IAAI,wCAAyCL","file":"dist\\js\\workers\\prefetch.service.worker.min.js","sourcesContent":["\r\nconst PrefetchServiceWorkerEvent = {\r\n\tProgress: 'progress',\r\n\tComplete: 'complete',\r\n};\r\n\r\nconst prefetched = {};\r\nconst controllers = {};\r\n\r\nfunction sendMessage(type, assets, data) {\r\n\tself.postMessage({\r\n\t\ttype: type,\r\n\t\tassets: assets,\r\n\t\tdata: data\r\n\t});\r\n}\r\n\r\nfunction onMessage(event) {\r\n\tconst id = event.data.id;\r\n\tconst assets = event.data.assets;\r\n\t// console.log('PrefetchServiceWorker.onMessage', id, assets);\r\n\tif (!id) {\r\n\t\treturn;\r\n\t}\r\n\tif (id && !assets) {\r\n\t\tconst controller = controllers[id];\r\n\t\tif (controller) {\r\n\t\t\t// console.log('PrefetchServiceWorker.Aborting', id);\r\n\t\t\tcontroller.abort();\r\n\t\t}\r\n\t\treturn;\r\n\t}\r\n\tif (!assets.length) {\r\n\t\treturn;\r\n\t}\r\n\tif (typeof Promise === 'undefined') {\r\n\t\treturn;\r\n\t}\r\n\tif (typeof fetch !== 'function') {\r\n\t\treturn;\r\n\t}\r\n\tconst options = {\r\n\t\tmode: 'cors', // no-cors, *cors, same-origin\r\n\t};\r\n\tif (self.AbortController) {\r\n\t\tconst controller = new AbortController();\r\n\t\toptions.signal = controller.signal;\r\n\t\tcontrollers[id] = controller;\r\n\t\t// console.log('AbortController', id);\r\n\t}\r\n\treturn PromiseAllProgress(assets.map(url => Prefetch(url, options)), function(progress) {\r\n\t\t// console.log('PrefetchServiceWorker.onMessage.Progress', progress);\r\n\t\tsendMessage(PrefetchServiceWorkerEvent.Progress, assets, progress);\r\n\t}).then(function(_) {\r\n\t\tdelete controllers[id];\r\n\t\t// console.log('PrefetchServiceWorker.onMessage.Complete', assets);\r\n\t\tsendMessage(PrefetchServiceWorkerEvent.Complete, assets);\r\n\t}).catch(function(error) {\r\n\t\tconsole.log('PrefetchServiceWorker.onMessage.error', error);\r\n\t});\r\n}\r\n\r\nself.addEventListener('message', onMessage);\r\n\r\nfunction Prefetch(url, options) {\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tconst resolved = prefetched[url];\r\n\t\tif (resolved) {\r\n\t\t\tresolve(url);\r\n\t\t} else {\r\n\t\t\tfetch(url, options).then(function(_) {\r\n\t\t\t\tprefetched[url] = true;\r\n\t\t\t\tresolve(url);\r\n\t\t\t}, function(error) {\r\n\t\t\t\t// console.log('PrefetchServiceWorker.Prefetch.error', error);\r\n\t\t\t\treject(error);\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n}\r\n\r\nfunction PromiseAllProgress(promises, onProgress) {\r\n\tconst total = promises.length;\r\n\tlet loaded = 0;\r\n\tif (typeof onProgress === 'function') {\r\n\t\tonProgress({ loaded, total });\r\n\t}\r\n\tfor (const promise of promises) {\r\n\t\tpromise.then(() => {\r\n\t\t\tloaded++;\r\n\t\t\tif (typeof onProgress === 'function') {\r\n\t\t\t\tonProgress({ loaded, total });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\treturn Promise.all(promises);\r\n}\r\n"]}